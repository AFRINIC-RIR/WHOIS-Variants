<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                           http://camel.apache.org/schema/spring
                           http://camel.apache.org/schema/spring/camel-spring.xsd">

    <import resource="classpath*:/whois-core-context.xml"/>

    <camelContext xmlns="http://camel.apache.org/schema/spring">

        <!-- Exception handler -->
        <onException>
            <exception>whois.core.api.CommandException</exception>
            <handled>
                <constant>true</constant>
            </handled>
            <bean ref="ExceptionService" method="commandFailed"/>
        </onException>

        <!-- Load balancer -->
        <route id="restlet-query-master">
            <from uri="restlet:http://localhost:4480/{id}/{format}?restletMethod=get"/>
            <loadBalance>
                <roundRobin/>
                <to uri="direct:query-slave-01"/>
                <to uri="direct:query-slave-02"/>
                <to uri="direct:query-slave-03"/>
            </loadBalance>
        </route>

        <!-- Multicaster -->
        <route id="restlet-update-master">
            <from uri="restlet:http://localhost:4480/?restletMethods=post,put"/>
            <multicast stopOnException="true" parallelProcessing="true">
                <to uri="direct:update-whois"/>
                <to uri="direct:update-solr"/>
                <!--<to uri="direct:update-couchdb"/>-->
                <to uri="direct:update-email"/>
            </multicast>
        </route>

        <route id="query-slave-01">
            <from uri="direct:query-slave-01"/>
            <transform>
                <simple>${header.id}</simple>
            </transform>
            <setHeader headerName="command">
                <constant>query</constant>
            </setHeader>
            <bean ref="WhoisService" method="messageReceived"/>
            <setHeader headerName="conversion">
                <simple>rpsl2${header.format}</simple>
            </setHeader>
            <bean ref="TextConvertService" method="messageReceived"/>
            <to uri="log:whois.core.api.QueryCommand?level=INFO&amp;multiline=true&amp;skipBodyLineSeparator=false"/>
            <to uri="velocity:whois-query.vm"/>
        </route>

        <route id="query-slave-02">
            <from uri="direct:query-slave-02"/>
            <transform>
                <simple>${header.id}</simple>
            </transform>
            <setHeader headerName="command">
                <constant>query</constant>
            </setHeader>
            <bean ref="WhoisService" method="messageReceived"/>
            <setHeader headerName="conversion">
                <simple>rpsl2${header.format}</simple>
            </setHeader>
            <bean ref="TextConvertService" method="messageReceived"/>
            <to uri="log:whois.core.api.QueryCommand?level=INFO&amp;multiline=true&amp;skipBodyLineSeparator=false"/>
            <to uri="velocity:whois-query.vm"/>
        </route>

        <route id="query-convert-slave-03">
            <from uri="direct:query-convert-slave-03"/>
            <transform>
                <simple>${header.id}</simple>
            </transform>
            <setHeader headerName="command">
                <constant>query</constant>
            </setHeader>
            <bean ref="WhoisService" method="messageReceived"/>
            <setHeader headerName="conversion">
                <simple>rpsl2${header.format}</simple>
            </setHeader>
            <bean ref="TextConvertService" method="messageReceived"/>
            <to uri="log:whois.core.api.QueryCommand?level=INFO&amp;multiline=true&amp;skipBodyLineSeparator=false"/>
            <to uri="velocity:whois-query.vm"/>
        </route>

        <route id="update-whois">
            <from uri="direct:update-whois"/>
            <setHeader headerName="command">
                <constant>update</constant>
            </setHeader>
            <bean ref="WhoisService" method="messageReceived"/>
            <to uri="log:whois.core.api.UpdateCommand?level=INFO&amp;multiline=true&amp;skipBodyLineSeparator=false"/>
            <to uri="velocity:whois-query.vm"/>
        </route>

        <route id="update-solr">
            <from uri="direct:update-solr"/>
            <to uri="log:whois.core.api.UpdateCommand?level=INFO&amp;multiline=true&amp;skipBodyLineSeparator=false&amp;showStreams=true"/>
            <bean ref="Rpsl2SolrService" method="messageReceived"/>
            <setHeader headerName="SolrOperation">
                <constant>INSERT</constant>
            </setHeader>
            <to uri="solrCloud://bamboo01.dev.mu.afrinic.net:8983/solr?collection=collection1&amp;allowCompression=true"/>
            <setHeader headerName="SolrOperation">
                <constant>COMMIT</constant>
            </setHeader>
            <to uri="solrCloud://bamboo01.dev.mu.afrinic.net:8983/solr?collection=collection1&amp;allowCompression=true"/>
        </route>

        <!--
        <route id="update-couchdb">
            <from uri="direct:update-couchdb"/>
            <bean ref="Rpsl2CouchdbService" method="messageReceived"/>
            <to uri="couchdb:http://localhost:5984/whois?createDatabase=true"/>
        </route>
        -->

        <route id="update-email">
            <from uri="direct:update-email"/>
            <bean ref="TextConvertService" method="messageReceived"/>
            <to uri="smtp://smtp.afrinic.net?From=service@afrinic.net&amp;To=yogesh@afrinic.net&amp;Subject=WHOIS+Update"/>
        </route>

    </camelContext>

</beans>